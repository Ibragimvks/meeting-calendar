<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Календарь встреч</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    table {
      width: 100%;
      max-width: 600px;
      margin: auto;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #aaa;
      width: 14.28%;
      height: 80px;
      position: relative;
    }
    .color-segment {
      position: absolute;
      opacity: 0.5;
      pointer-events: none;
    }
    .form-container {
      margin-top: 20px;
      display: none;
    }
    .form-container input, select, button {
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>Календарь встреч</h1>
  <div>
    <button onclick="changeMonth(-1)">◀</button>
    <span id="monthYear"></span>
    <button onclick="changeMonth(1)">▶</button>
  </div>
  <table id="calendar"></table>

  <div class="form-container" id="form">
    <h3 id="selectedDate"></h3>
    <input type="text" id="name" placeholder="Ваше имя">
    <select id="status">
      <option value="busy">Занят</option>
      <option value="free">Свободен</option>
    </select>
    <select id="color">
      <option value="red">Красный</option>
      <option value="blue">Синий</option>
      <option value="green">Зеленый</option>
      <option value="orange">Оранжевый</option>
      <option value="purple">Фиолетовый</option>
    </select>
    <button onclick="submitEntry()">Сохранить</button>
    <div id="entriesList"></div>
  </div>

  <script>
    const calendarEl = document.getElementById('calendar');
    const currentMonthEl = document.getElementById('monthYear');
    const form = document.getElementById('form');
    const selectedDateEl = document.getElementById('selectedDate');
    const nameInput = document.getElementById('name');
    const statusInput = document.getElementById('status');
    const colorInput = document.getElementById('color');
    const entriesList = document.getElementById('entriesList');

    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    let selectedDate = null;

    const entries = JSON.parse(localStorage.getItem('calendarEntries') || '{}');

    function formatDate(year, month, day) {
      return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }

    function renderCalendar(year, month) {
      currentMonthEl.textContent = new Date(year, month).toLocaleString('ru-RU', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDay = firstDay === 0 ? 7 : firstDay;

      calendarEl.innerHTML = '<tr><th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th></tr>';
      let row = document.createElement('tr');

      for (let i = 1; i < startDay; i++) {
        row.appendChild(document.createElement('td'));
      }

      for (let day = 1; day <= daysInMonth; day++) {
        if ((startDay + day - 2) % 7 === 0 && day !== 1) {
          calendarEl.appendChild(row);
          row = document.createElement('tr');
        }

        let cell = document.createElement('td');
        cell.textContent = day;
        let dateStr = formatDate(year, month + 1, day);
        cell.dataset.date = dateStr;
        cell.style.position = 'relative';
        cell.innerHTML = day;

        if (entries[dateStr]) {
          const marks = entries[dateStr];
          const count = marks.length;

          if (count === 1) {
            const div = document.createElement('div');
            div.className = 'color-segment';
            div.style.backgroundColor = marks[0].color;
            div.style.top = '0';
            div.style.left = '0';
            div.style.width = '100%';
            div.style.height = '100%';
            cell.appendChild(div);
          } else if (count === 2) {
            for (let i = 0; i < 2; i++) {
              const div = document.createElement('div');
              div.className = 'color-segment';
              div.style.backgroundColor = marks[i].color;
              div.style.top = '0';
              div.style.left = `${i * 50}%`;
              div.style.width = '50%';
              div.style.height = '100%';
              cell.appendChild(div);
            }
          } else if (count === 3) {
            const div1 = document.createElement('div');
            div1.className = 'color-segment';
            div1.style.backgroundColor = marks[0].color;
            div1.style.top = '0';
            div1.style.left = '0';
            div1.style.width = '50%';
            div1.style.height = '100%';
            cell.appendChild(div1);

            const div2 = document.createElement('div');
            div2.className = 'color-segment';
            div2.style.backgroundColor = marks[1].color;
            div2.style.top = '0';
            div2.style.left = '50%';
            div2.style.width = '50%';
            div2.style.height = '50%';
            cell.appendChild(div2);

            const div3 = document.createElement('div');
            div3.className = 'color-segment';
            div3.style.backgroundColor = marks[2].color;
            div3.style.top = '50%';
            div3.style.left = '50%';
            div3.style.width = '50%';
            div3.style.height = '50%';
            cell.appendChild(div3);
          } else if (count >= 4) {
            const positions = [
              { top: '0', left: '50%' },
              { top: '0', left: '0' },
              { top: '50%', left: '0' },
              { top: '50%', left: '50%' }
            ];
            for (let i = 0; i < 4; i++) {
              const div = document.createElement('div');
              div.className = 'color-segment';
              div.style.backgroundColor = marks[i].color;
              div.style.top = positions[i].top;
              div.style.left = positions[i].left;
              div.style.width = '50%';
              div.style.height = '50%';
              cell.appendChild(div);
            }
          }
        }

        cell.addEventListener('click', () => onDayClick(dateStr));
        row.appendChild(cell);
      }

      while (row.children.length < 7) {
        row.appendChild(document.createElement('td'));
      }
      calendarEl.appendChild(row);
    }

    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      } else if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      renderCalendar(currentYear, currentMonth);
    }

    function onDayClick(dateStr) {
      selectedDate = dateStr;
      selectedDateEl.textContent = `Дата: ${dateStr}`;
      form.style.display = 'block';
      renderEntriesList();
    }

    function renderEntriesList() {
      const list = entries[selectedDate] || [];
      entriesList.innerHTML = list.map(e => `<p>${e.name}: ${e.status}</p>`).join('');
    }

    function submitEntry() {
      const name = nameInput.value.trim();
      const status = statusInput.value;
      const color = colorInput.value;
      if (!name || !status || !color) return;

      if (!entries[selectedDate]) entries[selectedDate] = [];

      if (entries[selectedDate].some(e => e.name === name)) return;

      entries[selectedDate].push({ name, status, color });
      localStorage.setItem('calendarEntries', JSON.stringify(entries));
      renderCalendar(currentYear, currentMonth);
      renderEntriesList();
    }

    renderCalendar(currentYear, currentMonth);
  </script>
</body>
</html>
